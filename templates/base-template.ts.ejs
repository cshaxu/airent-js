<% getGlobalImports().forEach((globalImport) => { -%>
<%- globalImport %>
<% }); -%>
import {
  AsyncLock,
  BaseEntity,
  LoadConfig,
  LoadKey,
  toArrayMap,
  toObjectMap,
} from '<%= config.airentPackage %>';
<% if (!schema.internal || schema.fields.some(isInternalType)) { -%>

/** generated */
import {
  <%= getThisEntityStrings().fieldRequestClass %>,
  <%= getThisEntityStrings().responseClass %>,
  <%_ schema.types.filter(isInternalType).forEach((type) => { -%>
  <%= getTypeStrings(type).typeName %>,
  <%_ }); -%>
} from './<%= getThisEntityStrings().typePackage %>';
<% } -%>
<% if (schema.types.some(isEntityType)) { -%>

/** associations */
  <%_ schema.types.filter(isEntityType).forEach((type) => { -%>
import { <%= getTypeStrings(type).entityClass %> } from '../<%= getTypeStrings(type).entityPackage %>';
  <%_ }); -%>
<% } -%>
<% if (schema.types.some(isExternalType)) { -%>

/** external types */
  <%_ schema.types.filter(isExternalType).forEach((type) => { -%>
import { <%= getTypeStrings(type).externalClass %> } from '<%= getTypeStrings(type).externalPackage %>';
  <%_ }); -%>
<% } -%>

<% if (schema.deprecated) { -%>
/** @deprecated */
<% } -%>
export class <%= getThisEntityStrings().baseClass %> extends BaseEntity<
  <%= schema.modelName %><%= schema.internal ? '' : `, ${getThisEntityStrings().fieldRequestClass}, ${getThisEntityStrings().responseClass}` %>
> {
<% schema.fields.filter(isPrimitiveField).forEach((field) => { -%>
  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public <%= field.name %>: <%= getFieldStrings(field).fieldType %>;
<% }); -%>

<% schema.fields.filter(isAssociationField).forEach((field) => { -%>
  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  protected <%= field.name %>?: <%= getFieldStrings(field).fieldType %>;
<% }); -%>

  public constructor(
    model: <%= schema.modelName %>,
    group: <%= getThisEntityStrings().baseClass %>[],
    lock: AsyncLock,
  ) {
    super(group, lock);

<% schema.fields.filter(isPrimitiveField).forEach((field) => { -%>
    this.<%= field.name %> = <%= getFieldStrings(field).fieldInitializer %>;
<% }); -%>

    this.initialize();
  }
<% if (!schema.internal) { -%>

  public static defaultFieldRequest: <%= getThisEntityStrings().fieldRequestClass %> = {
  <%_ schema.fields.filter(isDefaultPresentableField).forEach((field) => { -%>
    <%= field.name %>: true,
  <%_ }); -%>
  };

  public async present(request?: <%= getThisEntityStrings().fieldRequestClass %> | boolean): Promise<<%= getThisEntityStrings().responseClass %>> {
    if (request === false) {
      throw new Error('unprocessable field request');
    }
    const fieldRequest = request === true || request === undefined
      ? <%= getThisEntityStrings().baseClass %>.defaultFieldRequest
      : request;
    return {
  <%_ schema.fields.filter(isExternalField).forEach((field) => { -%>
      <%= field.name %>: <%- getFieldStrings(field).fieldPresenter %>,
  <%_ }); -%>
    };
  }
<% } -%>
<% if (!schema.skipSelfLoader) { -%>

/** self loaders */

public static async getOne<ENTITY extends <%= getThisEntityStrings().baseClass %>>(this: any, key: LoadKey): Promise<ENTITY | null> {
  return await this.getMany([key]).then((array: ENTITY[]) => array.at(0) ?? null);
}

public static async getMany<ENTITY extends <%= getThisEntityStrings().baseClass %>>(this: any, keys: LoadKey[]): Promise<ENTITY[]> {
  const loadedModels = <%- getSelfLoadedModels() %>;
  return this.fromArray(loadedModels);
}
<% } -%>
<% if (schema.fields.some(isAssociationField)) { -%>

  /** associations */
<% } -%>
<% schema.fields.filter(isAssociationField).forEach((field) => { -%>

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  protected <%= `${field.name}LoadConfig` %>: LoadConfig<<%= getThisEntityStrings().baseClass %>, <%= getFieldStrings(field).fieldClass %>> = {
    name: '<%= getFieldLoadConfigName(field) %>',
    filter: (one: <%= getThisEntityStrings().baseClass %>) => one.<%= field.name %> === undefined,
  <%_ if (!isGetterGeneratable(field)) { -%>
    // TODO: build your association key getter
  <%_ } -%>
    <%= isGetterGeneratable(field) ? '' : '// ' %>getter: (sources: <%= getThisEntityStrings().baseClass %>[]) => sources.map((one) => ({
  <%_ getSourceFields(field).forEach((sourceField, index) => { -%>
    <%= isGetterGeneratable(field) ? '' : '// ' %>  <%= field.targetFields[index] %>: one.<%= getFieldGetterName(sourceField) %>,
  <%_ }); -%>
    <%= isGetterGeneratable(field) ? '' : '// ' %>})),
  <%_ if (!isLoaderGeneratable(field)) { -%>
    // TODO: build your association data loader
  <%_ } -%>
    <%= isLoaderGeneratable(field) ? '' : '// ' %>loader: async (keys: LoadKey[]) => {
  <%_ if (isEntityTypeField(field)) { -%>
    <%= isLoaderGeneratable(field) ? '' : '// ' %>  const loadedModels = <%- getTargetLoadedModels(field) %>;
    <%= isLoaderGeneratable(field) ? '' : '// ' %>  return <%= getFieldStrings(field).fieldClass %>.fromArray(loadedModels);
  <%_ } else { -%>
    <%= isLoaderGeneratable(field) ? '' : '// ' %>  return <%- getTargetLoadedModels(field) %>;
  <%_ } -%>
    <%= isLoaderGeneratable(field) ? '' : '// ' %>},
  <%_ if (!isSetterGeneratable(field)) { -%>
    // TODO: build your association value setter
  <%_ } -%>
    <%= isSetterGeneratable(field) ? '' : '// ' %>setter: (sources: <%= getThisEntityStrings().baseClass %>[], targets: <%= getFieldStrings(field).fieldClass %>[]) => {
    <%= isSetterGeneratable(field) ? '' : '// ' %>  const map = <%- getTargetMap(field) %>;
    <%= isSetterGeneratable(field) ? '' : '// ' %>  sources.forEach((one) => (one.<%= field.name %> = <%- getSourceSetter(field) %>));
    <%= isSetterGeneratable(field) ? '' : '// ' %>},
  };

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  protected async <%= `load${toTitleCase(field.name)}` %>(): Promise<void> {
    await this.load(this.<%= `${field.name}LoadConfig` %>);
  }

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public async <%= getFieldStrings(field).fieldGetterName %>: Promise<<%= getFieldStrings(field).fieldType %>> {
    if (this.<%= field.name %> !== undefined) {
      return this.<%= field.name %>;
    }
    await this.<%= `load${toTitleCase(field.name)}` %>();
    return this.<%= field.name %><%= isNullableField(field) ? ' ?? null' : '!' %>;
  }

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public <%= `set${toTitleCase(field.name)}` %>(<%= field.name %>?: <%= getFieldStrings(field).fieldType %>): void {
    this.<%= field.name %> = <%= field.name %>;
  }
<% }); -%>
<% if (schema.fields.some(isComputedSyncField)) { -%>

  /** computed sync fields */
<% } -%>
<% schema.fields.filter(isComputedSyncField).forEach((field) => { -%>

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public <%= getFieldStrings(field).fieldGetterName %>: <%= getFieldStrings(field).fieldType %> {
    throw new Error('not implemented');
  }
<% }); -%>
<% if (schema.fields.some(isComputedAsyncField)) { -%>

  /** computed async fields */
<% } -%>
<% schema.fields.filter(isComputedAsyncField).forEach((field) => { -%>

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public async <%= getFieldStrings(field).fieldGetterName %>: Promise<<%= getFieldStrings(field).fieldType %>> {
    throw new Error('not implemented');
  }
<% }); -%>
}
