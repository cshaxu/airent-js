<% getBaseBeforeLines().forEach((line) => { -%>
<%- line %>
<% }); -%>
import {
  AsyncLock,
  BaseEntity,
  EntityConstructor,
  LoadConfig,
  LoadKey,
  toArrayMap,
  toObjectMap,
} from '<%= config.airentPackageForGenerated %>';
<% if (!entity.internal || entity.types.some(utils.isCustomType)) { -%>

/** generated */
import {
  <%_ if (!entity.internal) { -%>
  <%= entity.strings.fieldRequestClass %>,
  <%= entity.strings.responseClass %>,
  <%_ } -%>
  <%_ entity.types.filter(utils.isCustomType).forEach((type) => { -%>
  <%= type.name %>,
  <%_ }); -%>
} from './<%= entity.strings.typePackage %>';
<% } -%>
<% if (entity.types.some(utils.isEntityType)) { -%>

/** associations */
  <%_ entity.types.filter(utils.isEntityType).forEach((type) => { -%>
import { <%= type.strings.entityClass %> } from '../<%= type.strings.entityPackage %>';
  <%_ }); -%>
<% } -%>
<% if (entity.types.some(utils.isImportType)) { -%>

/** external types */
  <%_ entity.types.filter(utils.isImportType).forEach((type) => { -%>
import { <%= type.strings.externalClass %> } from '<%= type.strings.externalPackage %>';
  <%_ }); -%>
<% } -%>

<% if (entity.deprecated) { -%>
/** @deprecated */
<% } -%>
export class <%= entity.strings.baseClass %> extends BaseEntity<
  <%= entity.model %><%= entity.internal ? '' : `, ${entity.strings.fieldRequestClass}, ${entity.strings.responseClass}` %>
> {
<% entity.fields.filter(utils.isPrimitiveField).forEach((field) => { -%>
  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public <%= field.name %>: <%= field.strings.fieldType %>;
<% }); -%>
<% entity.fields.filter(utils.isAssociationField).forEach((field) => { -%>

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  protected <%= field.name %>?: <%= field.strings.fieldType %>;
<% }); -%>

  public constructor(
    model: <%= entity.model %>,
    group: <%= entity.strings.baseClass %>[],
    lock: AsyncLock,
  ) {
    super(group, lock);

<% entity.fields.filter(utils.isPrimitiveField).forEach((field) => { -%>
    this.<%= field.name %> = <%= field.strings.fieldInitializer %>;
<% }); -%>

    this.initialize();
  }
<% if (!entity.internal) { -%>

  public static defaultFieldRequest: <%= entity.strings.fieldRequestClass %> = {
  <%_ entity.fields.filter(utils.isDefaultPresentableField).forEach((field) => { -%>
    <%= field.name %>: true,
  <%_ }); -%>
  };

  public async present(request?: <%= entity.strings.fieldRequestClass %> | boolean): Promise<<%= entity.strings.responseClass %>> {
    if (request === false) {
      throw new Error('unprocessable field request');
    }
    const fieldRequest = request === true || request === undefined
      ? <%= entity.strings.baseClass %>.defaultFieldRequest
      : request;
    return {
  <%_ entity.fields.filter(utils.isPresentableField).forEach((field) => { -%>
      <%= field.name %>: <%- getFieldPresenter(field) %>,
  <%_ }); -%>
    };
  }
<% } -%>
<% if (!entity.skipSelfLoader) { -%>

  /** self loaders */

  public static async getOne<ENTITY extends <%= entity.strings.baseClass %>>(
    this: EntityConstructor<<%= entity.model %>, ENTITY>,
    key: LoadKey
  ): Promise<ENTITY | null> {
    return await (this as any)
      .getMany([key])
      .then((array: ENTITY[]) => array.at(0) ?? null);
  }

  public static async getMany<ENTITY extends <%= entity.strings.baseClass %>>(
    this: EntityConstructor<<%= entity.model %>, ENTITY>,
    keys: LoadKey[]
  ): Promise<ENTITY[]> {
    <%_ getSelfLoaderLines().forEach((line) => { -%>
    <%- line %>
    <%_ }); -%>
  }
<% } -%>
<% if (entity.fields.some(utils.isAssociationField)) { -%>

  /** associations */
<% } -%>
<% entity.fields.filter(utils.isAssociationField).forEach((field) => { -%>

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  protected <%= `${field.name}LoadConfig` %>: LoadConfig<<%= entity.strings.baseClass %>, <%= field.strings.fieldClass %>> = {
    name: '<%= getFieldLoadConfigName(field) %>',
    filter: (one: <%= entity.strings.baseClass %>) => one.<%= field.name %> === undefined,
  <%_ if (!isGetterGeneratable(field)) { -%>
    // TODO: build your association key getter
  <%_ } -%>
    <%= isGetterGeneratable(field) ? '' : '// ' %>getter: (sources: <%= entity.strings.baseClass %>[]) => {
  <%_ getLoadConfigGetterLines(field).forEach((line) => { -%>
    <%= isGetterGeneratable(field) ? '' : '// ' %>  <%- line %>
  <%_ }); -%>
    <%= isGetterGeneratable(field) ? '' : '// ' %>},
  <%_ if (!isLoaderGeneratable(field)) { -%>
    // TODO: build your association data loader
  <%_ } -%>
    <%= isLoaderGeneratable(field) ? '' : '// ' %>loader: async (keys: LoadKey[]) => {
  <%_ getLoadConfigLoaderLines(field).forEach((line) => { -%>
    <%= isLoaderGeneratable(field) ? '' : '// ' %>  <%- line %>
  <%_ }); -%>
    <%= isLoaderGeneratable(field) ? '' : '// ' %>},
  <%_ if (!isSetterGeneratable(field)) { -%>
    // TODO: build your association value setter
  <%_ } -%>
    <%= isSetterGeneratable(field) ? '' : '// ' %>setter: (sources: <%= entity.strings.baseClass %>[], targets: <%= field.strings.fieldClass %>[]) => {
  <%_ getLoadConfigSetterLines(field).forEach((line) => { -%>
    <%= isSetterGeneratable(field) ? '' : '// ' %>  <%- line %>
  <%_ }); -%>
    <%= isSetterGeneratable(field) ? '' : '// ' %>},
  };

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public async <%= getFieldGetterName(field) %>: Promise<<%= field.strings.fieldType %>> {
    if (this.<%= field.name %> !== undefined) {
      return this.<%= field.name %>;
    }
    await this.load(this.<%= `${field.name}LoadConfig` %>);
    return this.<%= field.name %><%= utils.isNullableField(field) ? ' ?? null' : '!' %>;
  }

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public <%= `set${utils.toTitleCase(field.name)}` %>(<%= field.name %>?: <%= field.strings.fieldType %>): void {
    this.<%= field.name %> = <%= field.name %>;
  }
<% }); -%>
<% if (entity.fields.some(utils.isComputedSyncField)) { -%>

  /** computed sync fields */
<% } -%>
<% entity.fields.filter(utils.isComputedSyncField).forEach((field) => { -%>

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public <%= getFieldGetterName(field) %>: <%= field.strings.fieldType %> {
    throw new Error('not implemented');
  }
<% }); -%>
<% if (entity.fields.some(utils.isComputedAsyncField)) { -%>

  /** computed async fields */
<% } -%>
<% entity.fields.filter(utils.isComputedAsyncField).forEach((field) => { -%>

  <%_ if (field.deprecated) { -%>
  /** @deprecated */
  <%_ } -%>
  public async <%= getFieldGetterName(field) %>: Promise<<%= field.strings.fieldType %>> {
    throw new Error('not implemented');
  }
<% }); -%>
<% getBaseInsideLines().forEach((line) => { -%>
<%= line.length > 0 ? '  ' : '' %><%- line %>
<% }); -%>
}
<% getBaseAfterLines().forEach((line) => { -%>
<%= line.length > 0 ? '  ' : '' %><%- line %>
<% }); -%>
